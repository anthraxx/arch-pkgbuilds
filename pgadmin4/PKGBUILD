# Maintainer: Levente Polyak <anthraxx[at]archlinux[dot]org>
# Maintainer: Jerome Leclanche <jerome@leclan.ch>

pkgname=pgadmin4
pkgver=6.11
pkgrel=1
pkgdesc='Comprehensive design and management interface for PostgreSQL'
url='https://www.pgadmin.org/'
arch=('any')
license=('custom')
depends=('postgresql-libs' 'hicolor-icon-theme' 'python'

         'python-testtools'
         'python-webencodings'
         'python-flask-principal'
         'python-email-validator'

'python-jinja'

'python-flask'
'python-flask-gravatar'
'python-flask-login'
'python-flask-mail'
'python-flask-migrate'
'python-flask-sqlalchemy'
'python-flask-wtf'
'python-flask-compress'
'python-flask-paranoid'
'python-flask-babelex'
'python-flask-security-too'
'python-flask-socketio'
'python-wtforms'
'python-passlib'
'python-pytz'
'python-simplejson'
'python-six'
'python-speaklater3'
'python-sqlparse'
'python-psutil'
'python-psycopg2'
'python-dateutil'
'python-sqlalchemy'
'python-bcrypt'
'python-cryptography'
'python-sshtunnel'
'python-ldap3'
'python-gssapi'
'python-eventlet'
'python-httpagentparser'
'python-user-agents'
'python-authlib'
'python-requests'
         python-pyotp
         python-qrcode
         python-pillow
         python-boto3
         python-botocore
         python-urllib3
         python-werkzeug
       )
makedepends=('python-setuptools' 'python-sphinx' 'python-fixtures'
             'python-html5lib' 'python-pbr' 'python-mimeparse' 'python-pyrsistent'
             'imagemagick' 'yarn')
source=(https://ftp.postgresql.org/pub/pgadmin/pgadmin4/v${pkgver}/source/${pkgname}-${pkgver}.tar.gz{,.asc}
        pgAdmin4.desktop
        config_distro.py
        config_local.py)
validpgpkeys=('E8697E2EEF76C02D3A6332778881B2A8210976F2') # Package Manager (Package Signing Key) <packages@pgadmin.org>
sha512sums=('a0549be41a473484d77d7755977fc232b3e828a2648d77d7aa51e602c72e99c00c91169d3e08b39346b1af81587ca9e07103e361b75fe64efdccbff408b73f08'
            'SKIP'
            'b19dda3331585010c759099eb09f4db288ce4cd3d36882b56748e1e3756dc7bee2899d7438d496280498ec6a60f6e1ba90309d49fc599403f1fdc7e8817b6645'
            '16d00dc2095904a6b12da7039458f632873829ad98d4d7653eac5804032ba92097ccae4488d56467d0ea9bd64e2654a3dead73eb7924c947ff1737ff6e3b4745'
            'cf83e1357eefb8bdf1542850d66d8007d620e4050b5715dc83f4a921d36ce9ce47d0d13c5d85f2b0ff8318d2877eec2f63b931bd47417a81a538327af927da3e')

prepare() {
  cd ${pkgname}-${pkgver}

  sed -E -i requirements.txt \
    -e '/Flask>?=/d' \
    -e '/Flask-Gravatar>?=/d' \
    -e '/Flask-Login>?=/d' \
    -e '/Flask-Mail>?=/d' \
    -e '/Flask-Migrate>?=/d' \
    -e '/Flask-SQLAlchemy>?=/d' \
    -e '/Flask-WTF>?=/d' \
    -e '/Flask-Compress>?=/d' \
    -e '/Flask-Paranoid>?=/d' \
    -e '/Flask-BabelEx>?<?=/d' \
    -e '/Flask-Security-Too>?=/d' \
    -e '/Flask-SocketIO>?<?=/d' \
    -e '/WTForms>?=/d' \
    -e '/passlib>?=/d' \
    -e '/pytz>?=/d' \
    -e '/simplejson>?=/d' \
    -e '/six>?=/d' \
    -e '/speaklater3>?=/d' \
    -e '/sqlparse>?=/d' \
    -e '/psutil>?=/d' \
    -e '/psycopg2>?=/d' \
    -e '/python-dateutil>?=/d' \
    -e '/SQLAlchemy>?=/d' \
    -e '/bcrypt>?<?=/d' \
    -e '/cryptography>?<?=/d' \
    -e '/sshtunnel>?=/d' \
    -e '/ldap3>?=/d' \
    -e '/gssapi>?<?=/d' \
    -e '/eventlet>?<?=/d' \
    -e '/httpagentparser>?<?=/d' \
    -e '/user-agents>?<?=/d' \
    -e '/pywinpty>?<?=/d' \
    -e '/Authlib>?<?=/d' \
    -e '/requests>?<?=/d' \
    -e '/pyotp>?<?=/d' \
    -e '/qrcode>?<?=/d' \
    -e '/Pillow>?<?=/d' \
    -e '/boto3>?<?=/d' \
    -e '/botocore>?<?=/d' \
    -e '/urllib3>?<?=/d' \
    -e '/Werkzeug>?=/d' \

    -e '/azure-mgmt-rdbms>?=/d' \
    -e '/azure-mgmt-resource>?=/d' \
    -e '/azure-mgmt-subscription>?=/d' \
    -e '/azure-identity>?=/d' \
    -e '/^#.*/d' \
    -e '/^$/d'
  if [[ -s requirements.txt ]]; then
    echo "ERROR: requirements.txt must be empty:"
    cat requirements.txt
    exit 1
  fi
}

build() {
  export LANG=en_US.UTF-8
  export LC_ALL=en_US.UTF-8
  export PGADMIN_PYTHON_DIR=/usr

  cd ${pkgname}-${pkgver}
  # override doctree directory
  make docs SPHINXOPTS='-d /tmp/'

  yarn install
  yarn run bundle
}

package() {
  cd ${pkgname}-${pkgver}

  install -Dm 755 runtime/pgAdmin4 "${pkgdir}/usr/lib/pgadmin4/runtime/pgAdmin4"
  cp -a docs web runtime "${pkgdir}/usr/lib/pgadmin4"
  install -Dm 644 "${srcdir}"/config_{distro,local}.py -t "${pkgdir}/usr/lib/pgadmin4/web"

  install -Dm 644 runtime/assets/pgAdmin4-0.png "${pkgdir}/usr/share/icons/hicolor/256x256/apps/pgAdmin4.png"
  install -Dm 644 runtime/assets/pgAdmin4-1.png "${pkgdir}/usr/share/icons/hicolor/48x48/apps/pgAdmin4.png"
  install -Dm 644 runtime/assets/pgAdmin4-2.png "${pkgdir}/usr/share/icons/hicolor/32x32/apps/pgAdmin4.png"
  install -Dm 644 runtime/assets/pgAdmin4-3.png "${pkgdir}/usr/share/icons/hicolor/16x16/apps/pgAdmin4.png"
  install -Dm 644 "${srcdir}/pgAdmin4.desktop" -t "${pkgdir}/usr/share/applications"

  install -D /dev/stdin "${pkgdir}/usr/bin/pgadmin4" <<END
#!/bin/sh
cd /usr/lib/pgadmin4
export PGADMIN_SERVER_MODE='OFF'
python web/pgAdmin4.py "\$@"
END

END

  install -Dm 644 LICENSE -t "${pkgdir}/usr/share/licenses/${pkgname}"
}

# vim: ts=2 sw=2 et:
