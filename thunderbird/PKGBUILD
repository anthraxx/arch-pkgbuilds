# Maintainer: Levente Polyak <anthraxx[at]archlinux[dot]org>
# Contributor: Jan Alexander Steffens (heftig) <jan.steffens@gmail.com>
# Contributor: Ionut Biru <ibiru@archlinux.org>
# Contributor: Alexander Baldeck <alexander@archlinux.org>
# Contributor: Dale Blount <dale@archlinux.org>
# Contributor: Anders Bostrom <anders.bostrom@home.se>

pkgbase=thunderbird
pkgname=(thunderbird)
pkgver=102.1.2
pkgrel=1
pkgdesc='Standalone mail and news reader from mozilla.org'
url='https://www.mozilla.org/thunderbird/'
arch=(x86_64)
license=(MPL GPL LGPL)
depends=(
  glibc gtk3 libgdk-3.so libgtk-3.so mime-types dbus libdbus-1.so dbus-glib
  alsa-lib nss hunspell sqlite ttf-font libvpx libvpx.so zlib bzip2 libbz2.so
  botan libwebp libwebp.so libwebpdemux.so libevent libjpeg-turbo libffi
  libffi.so nspr gcc-libs libx11 libxrender libxfixes libxext libxcomposite
  libxdamage pango libpango-1.0.so cairo gdk-pixbuf2 icu libicui18n.so
  libicuuc.so freetype2 libfreetype.so fontconfig libfontconfig.so glib2
  libglib-2.0.so pixman libpixman-1.so gnupg
)
makedepends=(
  unzip zip diffutils python python-setuptools yasm nasm mesa imake libpulse
  xorg-server-xvfb autoconf2.13 rust clang llvm cbindgen nodejs lld
  gawk perl findutils libotr wasi-compiler-rt wasi-libc wasi-libc++ wasi-libc++abi
)
options=(!emptydirs !makeflags !lto)
source=(https://ftp.mozilla.org/pub/mozilla.org/thunderbird/releases/$pkgver/source/thunderbird-$pkgver.source.tar.xz{,.asc}
        thunderbird.desktop
        vendor-prefs.js
        distribution.ini
        mozconfig.cfg
        metainfo.patch
        cbindgen-0.24.patch
        rustc_version-0.4.0.patch
        packed_simd_2-0.3.8.patch)
validpgpkeys=(
  14F26682D0916CDD81E37B6D61B7B526D98F0353 # Mozilla Software Releases <release@mozilla.com>
  4360FE2109C49763186F8E21EBE41E90F6F12F6D # Mozilla Software Releases <release@mozilla.com>
)

# Google API keys (see http://www.chromium.org/developers/how-tos/api-keys)
# Note: These are for Arch Linux use ONLY. For your own distribution, please
# get your own set of keys. Feel free to contact foutrelis@archlinux.org for
# more information.
_google_api_key=AIzaSyDwr302FpOSkGRpLlUpPThNTDPbXcIn_FM

# Mozilla API keys (see https://location.services.mozilla.com/api)
# Note: These are for Arch Linux use ONLY. For your own distribution, please
# get your own set of keys. Feel free to contact heftig@archlinux.org for
# more information.
_mozilla_api_key=16674381-f021-49de-8622-3021c5942aff

prepare() {
  cd $pkgname-$pkgver

  echo "${noextract[@]}"

  local src
  for src in "${source[@]}"; do
    src="${src%%::*}"
    src="${src##*/}"
    [[ $src = *.patch ]] || continue
    msg2 "Applying patch $src..."
    patch -Np1 < "../$src"
  done

  printf "%s" "$_google_api_key" >google-api-key
  printf "%s" "$_mozilla_api_key" >mozilla-api-key
  cp ../mozconfig.cfg .mozconfig
  sed "s|@PWD@|${PWD@Q}|g" -i .mozconfig
}

build() {
  cd $pkgname-$pkgver
  if [[ -n "${SOURCE_DATE_EPOCH}" ]]; then
    export MOZ_BUILD_DATE=$(date --date "@${SOURCE_DATE_EPOCH}" "+%Y%m%d%H%M%S")
  fi
  export MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=system
  export MOZBUILD_STATE_PATH="${srcdir}/mozbuild"
  ./mach configure
  ./mach build
  ./mach buildsymbols
}

package_thunderbird() {
  optdepends=(
    'libotr: OTR support for active one-to-one chats'
    'libnotify: Notification integration'
  )

  cd $pkgname-$pkgver
  DESTDIR="$pkgdir" ./mach install

  install -Dm 644 ../vendor-prefs.js -t "$pkgdir/usr/lib/$pkgname/defaults/pref"
  install -Dm 644 ../distribution.ini -t "$pkgdir/usr/lib/$pkgname/distribution"
  install -Dm 644 ../thunderbird.desktop -t "$pkgdir/usr/share/applications"
  install -Dm 644 comm/mail/branding/thunderbird/net.thunderbird.Thunderbird.appdata.xml \
    "$pkgdir/usr/share/metainfo/net.thunderbird.Thunderbird.appdata.xml"

  for i in 16 22 24 32 48 64 128 256; do
    install -Dm644 comm/mail/branding/thunderbird/default${i}.png \
      "$pkgdir/usr/share/icons/hicolor/${i}x${i}/apps/$pkgname.png"
  done
  install -Dm644 comm/mail/branding/thunderbird/TB-symbolic.svg \
    "$pkgdir/usr/share/icons/hicolor/symbolic/apps/thunderbird-symbolic.svg"

  # Use system-provided dictionaries
  ln -Ts /usr/share/hunspell "$pkgdir/usr/lib/$pkgname/dictionaries"
  ln -Ts /usr/share/hyphen "$pkgdir/usr/lib/$pkgname/hyphenation"

  # Install a wrapper to avoid confusion about binary path
  install -Dm755 /dev/stdin "$pkgdir/usr/bin/$pkgname" <<END
#!/bin/sh
exec /usr/lib/$pkgname/thunderbird "\$@"
END

  # Replace duplicate binary with wrapper
  # https://bugzilla.mozilla.org/show_bug.cgi?id=658850
  ln -srf "$pkgdir/usr/bin/$pkgname" \
    "$pkgdir/usr/lib/$pkgname/thunderbird-bin"
}

_package_i18n() {
  pkgdesc="$2 language pack for Thunderbird"
  depends=("thunderbird>=$pkgver")
  install -Dm644 thunderbird-i18n-$pkgver-$1.xpi \
    "$pkgdir/usr/lib/thunderbird/extensions/langpack-$1@thunderbird.mozilla.org.xpi"
}

_languages=(
  'af     "Afrikaans"'
  'ar     "Arabic"'
  'ast    "Asturian"'
  'be     "Belarusian"'
  'bg     "Bulgarian"'
  'br     "Breton"'
  'ca     "Catalan"'
  'cak    "Kaqchikel"'
  'cs     "Czech"'
  'cy     "Welsh"'
  'da     "Danish"'
  'de     "German"'
  'dsb    "Lower Sorbian"'
  'el     "Greek"'
  'en-GB  "English (British)"'
  'en-US  "English (US)"'
  'es-AR  "Spanish (Argentina)"'
  'es-ES  "Spanish (Spain)"'
  'et     "Estonian"'
  'eu     "Basque"'
  'fi     "Finnish"'
  'fr     "French"'
  'fy-NL  "Frisian"'
  'ga-IE  "Irish"'
  'gd     "Gaelic (Scotland)"'
  'gl     "Galician"'
  'he     "Hebrew"'
  'hr     "Croatian"'
  'hsb    "Upper Sorbian"'
  'hu     "Hungarian"'
  'hy-AM  "Armenian"'
  'id     "Indonesian"'
  'is     "Icelandic"'
  'it     "Italian"'
  'ja     "Japanese"'
  'ka     "Georgian"'
  'kab    "Kabyle"'
  'kk     "Kazakh"'
  'ko     "Korean"'
  'lt     "Lithuanian"'
  'ms     "Malay"'
  'nb-NO  "Norwegian (Bokm√•l)"'
  'nl     "Dutch"'
  'nn-NO  "Norwegian (Nynorsk)"'
  'pa-IN  "Punjabi (India)"'
  'pl     "Polish"'
  'pt-BR  "Portuguese (Brazilian)"'
  'pt-PT  "Portuguese (Portugal)"'
  'rm     "Romansh"'
  'ro     "Romanian"'
  'ru     "Russian"'
  'sk     "Slovak"'
  'sl     "Slovenian"'
  'sq     "Albanian"'
  'sr     "Serbian"'
  'sv-SE  "Swedish"'
  'th     "Thai"'
  'tr     "Turkish"'
  'uk     "Ukrainian"'
  'uz     "Uzbek"'
  'vi     "Vietnamese"'
  'zh-CN  "Chinese (Simplified)"'
  'zh-TW  "Chinese (Traditional)"'
)
_url=https://ftp.mozilla.org/pub/mozilla.org/thunderbird/releases/$pkgver/linux-x86_64/xpi

for _lang in "${_languages[@]}"; do
  _locale=${_lang%% *}
  _pkgname=thunderbird-i18n-${_locale,,}

  pkgname+=($_pkgname)
  source+=("thunderbird-i18n-$pkgver-$_locale.xpi::$_url/$_locale.xpi")
  eval "package_$_pkgname() {
    _package_i18n $_lang
  }"
done

# Don't extract languages
noextract=()
for _src in "${source[@]%%::*}"; do
    case "$_src" in 
      *.xpi) noextract+=("$_src") ;;
    esac
done

sha512sums=('f5c6c77e932b30b43eaa6384b1dd1ab511d0ae8262cb51a5789f7c633235d5f8f343000d1cc1cae12e00a1d73571a814f98b0bf78681e00d7a51a34cfefdfdf1'
            'SKIP'
            'a0061fcb2a7f66061e336a8d95948592f56f4752e56467f14ba63846720ebf845cce7511d1a2637e3b80d5a1ffdaa2fb783fa37195103425ef65222d45372012'
            '6918c0de63deeddc6f53b9ba331390556c12e0d649cf54587dfaabb98b32d6a597b63cf02809c7c58b15501720455a724d527375a8fb9d757ccca57460320734'
            '5cd3ac4c94ef6dcce72fba02bc18b771a2f67906ff795e0e3d71ce7db6d8a41165bd5443908470915bdbdb98dddd9cf3f837c4ba3a36413f55ec570e6efdbb9f'
            '8c855cac4ca59b01b31cd7926bab99c43cdc4fb0d573571213708a2de1658ec00b1bc1f524ed01308de9d15ba0390ba8df8928aee9a77bcae07d93ad0869bd6e'
            '7e43b1f25827ddae615ad43fc1e11c6ba439d6c2049477dfe60e00188a70c0a76160c59a97cc01d1fd99c476f261c7cecb57628b5be48874be7cf991c22db290'
            '3526402ccae1f0428f2e45bae8d0b2cb909ac2698bc3508b692b827839ccb21203ce414206039776f6ce946fc53e636290b7870e9886284d5e9d1e8ad050aac9'
            '0b04788024e02bb70b0ffb7b1e0112ddfb191821e740f64abf44a1f1de6b663345c59120a13597ea5231d0adf0286739752e5a52b529f191fae4f52474f27af5'
            '317737e450a413839a7570de474c8be6089b5119a15c96c235079c4fe2bd73134eef7718a6e757b3e6a40d23e40c29c5e31890f2cab4799a02d9d6bbd8e71df3'
            '3619cdb9e7745b090222905568393f0a9b28625d9742ebcfce53b996fc64b4745c101d98c1e2cdb9bdc95d97d382e8b12d37f5a1e4fd4d3d2c35f785b99816bf'
            '9a6db8a26633ff9b9b270c70d43d5419f33a9bfc35164724780ff15769e72f97245a107f11589527732f435c923a8b24d4a06bdad80ae65f9ad7955c68b1842d'
            '1fbad8d4fa39d101b1c5272ce429d8363c7bbe4d7b170e10340cef2856ef07befbd53abf64f45ce5c36077f4a0d2bcff8659ba328fc857d4ba05c959217a3115'
            '0708c51c2653a16f82fe748b820f211d65a8f76b5cc561163b492538608f922605eabdeddfcc442e0b0d263727f7ecc31c13fac47a65331ab7e98148608166c0'
            'd77931227b1258484fcaa310147eceb73533d78ca1c7fe97e085122a9bd400d1c3b0cec176812f2aad515ce929cf20887913101e9c85c89f0c48df31aad51aa1'
            '6a62a5724dae9c1eacae75cdacc605162f9653f7ca69dd393399b86140728f0deb16217bd47fc37769083d26c8ebdfd9b643f5faaea18ed094857a29044bf49c'
            '851490137c929da1b5196288418231ed5eb90b8bab0269900c9f2746f15e9f91f61c003d9341dbfa531c36249643eb39cde66e5602167be09eb429c2761da9b3'
            'fab05cae22ed262aa9d245160747db75415d0cacbaf3448cb16b5ac7ddd9398c51ed404b8d062133c5e9a3bf61c1c11c91dcf809abbb8bd410f2c2d4c04bcb3b'
            'f50dfc0a83719173c36f3ae6ec59884e1ea6a621064479c0101d67509e36d7731043898fc8fceb3ed149e80bdd5950fabf0a02d9719abf618f4066b98bf22cb9'
            'a5ca9c39243c97b1b4401a687704754ffecea7a37334ab718b8b008dcb04f75bc338a751d3552a6cc88d1c6e31c724204f82d5c12f30eb2f24a18681988c62c8'
            '932b160819967dee9910ba1d2b28b850295f3b65d7403651d1a5d7a28dc390fe5d9a85ade77d9dce3e2a800b1a4af572a73cec5da4961917da7cf79330d146b1'
            '05557414f330169532b703d716ebfc92a8a093e41195f77c570cb5bbb9f9a8fcb240ed9652bf05cc77ac665d590c8277a7b62cb0e09cad3cb79edea3c9eaf14b'
            '8329373283f5b8a4dca6c90bb56a1f0ef24066a02be9201c01f1fd7ca6ec4da60f54e4cd378ec9b40c6d54c4435f93b454d2385604478e6e5c24303bd074944a'
            '9872d09fe69b6d8451bf457f9403718240f48bce3b2ca69715a7e27540593cf9df87451c9a088c484267d941938ec12acb6256569031ead5a488bc4653daa478'
            'ab79c021f931e7a891fad7e5c7db6f20eabffadab72a97a5191a9f07d55f573457bc4678fcb99eb8b41761f8d0f9cdb03a7f9482102c299cb54ff9ed855b4707'
            '4ef90a0df437d320079a95d73217f9ed8e13b9aac7c2a88a2ee96d1598f03512b1d60536d2d4e8e12997d3d1ee8d06aa6504b1238849b7377a29d99ad8c8aa8f'
            'a5d6e8efbfe2a2c872f8a98c5fb23274b8b8a02b6a8d8f95afe2906740d400012e4e9296bcca96f422b7005378e88e967a487a784e94500d58452446cfa89b4d'
            'ade12fd5cffa8309bb33988c2e2f0e24d5faca2867a0d82f9255b2c671e73eb745cb3c759697270504c2173bf5826e2f1c8946ea2b942dff88f05540a85f6393'
            'b1014c44e1fc2ef19ce99befea4a64d60c8ee8bc6968dd68069fdca972124762f4f5bf8a693d7ec3d72ce8fb3d436e4409ae178ae8870423b0754e2882c79b38'
            'f396529dba421cdb950475a889d12278419ccda423c676faac56754d3891ca7535aff6246d1a33e389f6ec4a3509a9567804009dfd3d92ebf12d77eddcbf1b8f'
            '1fefa33f7306af48bca31a4ed870694c23eb40d8dbee14bc2c104c10df8cd72ff0f5a1c4be6133d4b6db832fbb15068d10ceba9b3eed68721ac3d2f09ebcf920'
            '79cfc4383bc618a2695c4f1dbf1cc3d3fc91c6c06f0682b848d4409ab4fe4e9963b16e64d885c4eaec35edfee734e6c83ac17ac7582ceacdbe2060645779f60b'
            '3f41301922cbfea54119bc321ae7c45f0824ed048ed8c0139aca978fea16180991d5e1d0df485460b3ab5a63df53d03c6bec40c375cb95ce3bb32d6bd0b35dfc'
            'b81fdb969376b332cb2045285949f2d6bda56507a2b49642cce98d0c55af7a8a9fa2621db768fafadedad5783e8fcaff42ea18a4c6dc4a191e7eca5fb8f12bc8'
            '81e4b3e8e560e0de71dbd7262d817d6a964e9d59162fb86c8899689fdbe3e915d5eca3e8dd53b491b30beeb5b32dfd9d307673625a41ffd0fcaa1d4d153f19ad'
            '5a562375e87f40bdd7b724c77f6bfdbc55a523f6894bde0e2c9eaf8f470b25c7436fe7d443ecba5a9cfbc8f10d5dd873cf391f6672dcf7ce4eaa48959e2f91f6'
            '62cde12bfb3de77b56ef11adf847766dec4f1fd603f33f3a473c19bb2c6a7bde6d460cf62ab90486a6cd9d945c4179383afc21dd82df60e8c4f1f6f0ccb0d01d'
            '45b1b81b2eac33179455916bc8428dd263a5134ad87c3851c992495ad1e3c2564c827ed040f91336483bef15ae509695a214e65fd51b1da6bb7c5bceda02708d'
            '157d113d222d957fde020051cfc9929ec9423ba5d835b5d248e786842ae26fc3804d9e99934a8a8500a4ba18c4b87797c2b6b27c6e59ef05b571bc111ededfd2'
            '85b4e2b9822c60e27593264be48c6262282561ecc7f8b00adc490137de21ae07774783fd5ca9382f39dc07568dd38c8a1c89e3760d164a01140247c397b6c5f9'
            'd939da036bca720a416304c55181f1506af95dea0d7b3a5db86c98592e74d245443f792047f8da999e65d6d2e1f7b93b2678d42b84c1b77b1898c6562808609e'
            'a24463d1e1a1b4f129dd90e4a45951234a4faff482ea6620f3e4a1894006be8771bcc22688095da798519d9fee4a85b1c0e4342a990b6a1460069e3086af45d1'
            '1f69f714d2c1c171407d38504048f8a61e650ae97e2d2127882063bc39b457762a690a3304a16e7eb31073708f2921cf24dd141076fa611353b202bcc10e6c36'
            'bcc1680d77bc2db4b868cef2d6ac7b4e5b5a7d37dfcfd5e76f2f7e4d712e95d5db4efa65faed7e20d5e2ca93df30c633c0fd165c6c811013cadb41c8f7528479'
            '0b81869f300c81230e6de8dea56131e65315ea7ff5805666d9acec9584a3b0edbccc1bbd2014b8c447e6794199336810f629d72114659aeedc332ab52910a85b'
            '4d8cf1d867cae8734851d95581eb509b9410504b33ff5c2c82b058f22ae116fb2480a6cce51f8338f63508ff511352e0db95bb09999dd8b886ae136b2c95a8c7'
            'ff5eeebc37d38d581560bdac42386992c4d8a3eea0543849005a23c555309c26f2a7840a1664e60a48a4bbd77a740358d51390e391ca3be15b818871cb9300a3'
            '809741371aef8ce84ba00b8096ca8c6c9c6b4726287b193ea5ca339c887a365f26c9dfb14ef85469ea2ef2a11686b16949526d951924ad0bc53e8f6f4f8cdef8'
            '1ade3c3570a17c1d453cc4b1df81751eb4aca162aa648334cfb3eb028ad44cb00030508e2cafccef827e388a3b31bb7a294a1b4bd365a999277be8bbe953ccaa'
            '4fddfac25b98d6d17aa3c59ec5ffebcf29642493da8a1424bbc0d9978e896576669d66b33e01df01b6aea37f01ac5bc93eb51f35bc8c47d9d5752264167b4a7a'
            '0f73e22cdc1c75cf9595a498e8c4c9eacf3ccd142b6a18e47079029afa6cb9168cc70096e4c9f042c2c59f78bb42de1c96da4f95827262e76c66ab5521df2a7a'
            'f56ff082fd0c099771878b456ff6206a768ee8347cb607857e8b586e2c8d7cca79197bfecced7558107e90a1a6d527b47d0cd7186f9cc85848a70dd9b61246c4'
            '8897c4c6d70422a1d89194e58419b560be174c530c4f7979900153cf51537c6f75991025bd58134dd6c053f867d6c50d5271908a1aec870b0de06d750ea9e5ff'
            '7f570fdd3b83d0f4928dfa92f15bc7379a470cffa6083c56c6babc0aadbf7c42968ee8cd5fbfe325840c7358c1fd97f8e8283d09c8680b927d4264cdd0901c14'
            '140c705ba262831f14564c2809f904059f0bd821d49d7d707d7865fca1701d3adce9916943edaba4cd8a881487ff5e2ee0215a16838f9d10472da0feb590a448'
            '42d8429856462ba6da465d5a255371b4bd3dc22e1b481c81c41f27999a43fc401ffdec5362e97316af0921b298f1debb58412fee2ba310a250845476dd89286f'
            '80340bc692da96cb633a593175056943a16c1e45ed055e56bb4e0053dd6500a78ae038147371cc13d41d7870b32079705722e09755677bc90ebd9fc2a0d88658'
            'cf96ddbaf3056d3963a88fdfb95f33ce4156d4a21b9625c53e10bbcf0dcca5e59acb1fad33991148f27fd7eeb7ad26d697611bada8faf4d8fddcc7df4bd2af69'
            'c46e6db6bf67223e460b1715f1a48675fa2ab4f89668034842a673f97a75fc934117aa7993c05acc8d658fb712b41dd30cb282f0d38928d66f6d9ec639b4fb12'
            'ae14e8535bfd26a32cc1e59a341fd7337345a990dc92753f8b44c5dced4afdd6fa01ec2471d87dbb4e5924c9afa41372361c1fe98df379f90ebfaf4fe2895fea'
            '29c0df70f8a7e3bb3f16263ce7a3e5b53b0f51b01e95adc98617edc583d7c4fbd691f03b265da9c4a57d8101a9c9a10cd19ca6d125aa4b6bc0b44134d4b491a8'
            '3efdfb0c588ee7b6a0c33c60c3ad88783b9345ee43843d008d7b578598c46fab8729408763e4de895ffba8536864e80c5b874ec4f22a0493039ee3161d1c0e0f'
            '1ffe2d049a5e4726fb7966a6d0fe370d22386067134c29d275f8d30c093986ef15cb026868a97796c9f6bc04c4f1e5b43c6f6fe62781189047f6f3887892d9f9'
            'bd80eb460dbc1f6776588fc49b96680645677ad1132a55684c849d3aa8fc9d996d4450335d0294c1645638fa1a65da8bd36d250dc62ca07f20892d7dcf261ec6'
            'f4570c985fcc85e20ed56a9d667c4aa9f9b8374c090406d7e01babdc6a4f72d55ba49b72764cf6347439fd1b51ba0ada090bbdce2b907d033d89c5845b120965'
            '049e7c959b9b54bbbaa0f47886ee4b9ed0aa412be987b1eb5ea2e720e74432440ee2f579c0b0138cde104099a6a0ef558ee2ab2d8d7e60a78d15c5d300cdbacb'
            'a1cfac8f36c561b00177fb276c6d98528b1a34df3647e42a33bd3298ee0b6c3e1a4a7ccb41db7a6b6b4655843ed74312a5b9bc5e742b33532693b1318188963c'
            'cfb545610e4e4c3f90fa083e6cc7af2e29fde9eac862e107827f9a05ad1212186736450cd34e767887afee36ed2ad7743f5e422dbb3cf58301f7f7bc0dfceb8f'
            '62a7b07db95e48dbb1b0687bf49c1ead5416b8231cf78ce1289d918b75b88a72d4fa72d133c2077e5217e9e2c1fe193c7e07fed52b8dce36722fdf65797f90ad'
            'e3a83f8d506da21d0a9b94a98e2558d563d417b2fe720822ff282b4b3400b5347ba69465a5e371c357e6fbf9cbe01780cc92c955bcdcac0a18a7e727e02de340'
            '2cc59b6d89030d202f24e72be23e04f22c78880b4f4f55d1562523dd17f6162643380856265fadbb3b6f311b72abfe43119667d1e73a4a5a77a507b14734c150'
            '58b89f090593cc9a44fe0233ccdf9c8a0a1166de7e8e34d74f02dfa4bf4bc133c76fbd4c57d1dcd991a5a1f42861ced949bf3ccc014bb76d833e856063d88d78'
            'dd32ad01a3b77c88b8dc7fac6d66fb1cf4e95ce3c3f7bca07bbde382c9d57956f247fb52da1b910e2453b14b2ab75d4b37205e8fbb9a283c5ff507467561bd2e')

# vim:set sw=2 et:
